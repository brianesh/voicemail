
Copy
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // ... [keep existing error handling code] ...

    if (accessToken) {
      // Store token in localStorage
      localStorage.setItem('access_token', accessToken);
      localStorage.setItem('expires_at', Date.now() + (expiresIn * 1000));
      localStorage.setItem('token_type', tokenType);

      // Get tab ID of original Gmail window
      const originalTabId = sessionStorage.getItem('originalTabId');
      const pendingCommand = sessionStorage.getItem('pendingCommand');
      
      // Clear stored values
      sessionStorage.removeItem('originalTabId');
      sessionStorage.removeItem('pendingCommand');
      
      authStatus.innerHTML = `
        <h2 class="success">Success!</h2>
        <p>Returning to Gmail...</p>
      `;

      setTimeout(() => {
        if (originalTabId) {
          // Update the original tab
          chrome.tabs.update(parseInt(originalTabId), {
            url: `https://mail.google.com/mail/u/0/?auth_success=true${pendingCommand ? '&pending_command=true' : ''}`,
            active: true
          });
          window.close(); // Close the auth window
        } else {
          // Fallback for non-extension contexts
          window.location.href = `https://mail.google.com/mail/u/0/?auth_success=true${pendingCommand ? '&pending_command=true' : ''}`;
        }
      }, 1000);
      
      } else {
        authStatus.innerHTML = `
          <h2 class="error">No Token Received</h2>
          <p>Unable to retrieve access token from the URL.</p>
          <button onclick="retryAuth()">Retry Authentication</button>
        `;
      }
    });

    function retryAuth() {
      // Clear any existing auth data
      localStorage.removeItem('access_token');
      localStorage.removeItem('expires_at');
      localStorage.removeItem('token_type');
      
      // Redirect to auth page
      const authUrl = new URL(window.location.origin);
      authUrl.pathname = '/auth';
      window.location.href = authUrl.toString();
    }
  </script>
</body>
</html>