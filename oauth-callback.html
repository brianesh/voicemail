<!DOCTYPE html>
<html>
<head>
  <title>OAuth Callback</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    .success { color: green; }
    .error { color: red; }
    button { padding: 8px 16px; margin-top: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="auth-status">
    <h2>Processing authentication...</h2>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const authStatus = document.getElementById('auth-status');
      
      // Get hash parameters
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      
      if (hashParams.get('error')) {
        showError(hashParams.get('error'), hashParams.get('error_description'));
        return;
      }

      const accessToken = hashParams.get('access_token');
      if (!accessToken) {
        showError('No access token received');
        return;
      }

      // Store token in both sessionStorage and localStorage
      const expiresIn = (parseInt(hashParams.get('expires_in')) || 3600) * 1000;
      const expiresAt = Date.now() + expiresIn;
      
      localStorage.setItem('access_token', accessToken);
      localStorage.setItem('expires_at', expiresAt);
      sessionStorage.setItem('gmail_access_token', accessToken);
      sessionStorage.setItem('gmail_expires_at', expiresAt);
      
      // Close this window and notify the opener
      if (window.opener) {
        window.opener.postMessage({
          type: 'oauth_callback',
          success: true,
          token: accessToken,
          expiresIn: parseInt(hashParams.get('expires_in')) || 3600
        }, window.location.origin);
        window.close();
      } else {
        // For tabs (not popups)
        window.location.href = buildRedirectUrl();
      }
    });

    function buildRedirectUrl() {
      const url = new URL('https://mail.google.com/mail/u/0/');
      url.searchParams.set('auth_success', 'true');
      return url.toString();
    }

    function showError(error, description) {
      document.getElementById('auth-status').innerHTML = `
        <h2 class="error">Authentication Failed</h2>
        <p>${error || 'Unknown error'}</p>
        ${description ? `<p>${description}</p>` : ''}
        <button onclick="window.location.href='/'">Try Again</button>
      `;
    }
  </script>
</body>
</html>