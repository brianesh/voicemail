<script>
    // 1. Extract parameters securely
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const state = params.get('state');
    const error = params.get('error');
    
    // 2. Error handling
    if (error) {
      console.error('OAuth Error:', error);
      alert(`Authorization failed: ${params.get('error_description') || error}`);
      window.close();
      throw new Error(error);
    }
    
    // 3. State validation (critical security check)
    const savedState = sessionStorage.getItem('oauth_state'); // Changed from localStorage
    if (!state || state !== savedState) {
      console.error('State mismatch:', { received: state, expected: savedState });
      alert('Security error: Invalid state parameter');
      window.close();
      throw new Error('Invalid state');
    }
    
    // 4. Token exchange with PKCE
    (async function() {
      try {
        const verifier = sessionStorage.getItem('pkce_verifier'); // Changed from localStorage
        if (!verifier) throw new Error('Missing PKCE verifier');
    
        const response = await fetch('https://oauth2.googleapis.com/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            code,
            client_id: '629991621617-u5vp7bh2dm1vd36u2laeppdjt74uc56h.apps.googleusercontent.com',
            redirect_uri: 'http://localhost:8080/callback', // Must match EXACTLY
            grant_type: 'authorization_code',
            code_verifier: verifier
          })
        });
    
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Token exchange failed');
        }
    
        const tokens = await response.json();
        
        // 5. Secure token handling
        sessionStorage.setItem('gmail_access_token', tokens.access_token);
        if (tokens.refresh_token) {
          // Send to backend for secure storage instead of storing client-side
          await fetch('/store-refresh-token', {
            method: 'POST',
            body: JSON.stringify({ token: tokens.refresh_token }),
            headers: { 'Content-Type': 'application/json' }
          });
        }
    
        // 6. Redirect to Gmail
        window.location.href = 'https://mail.google.com';
    
      } catch (err) {
        console.error('Token exchange error:', err);
        alert(`Authentication failed: ${err.message}`);
        window.close();
      } finally {
        // Cleanup
        sessionStorage.removeItem('oauth_state');
        sessionStorage.removeItem('pkce_verifier');
      }
    })();
    </script>