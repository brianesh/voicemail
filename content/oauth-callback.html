<!-- oauth-callback.html -->
<script>
    // 1. Extract the authorization code
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    
    // 2. Verify state (anti-CSRF)
    if (state !== localStorage.getItem('oauth_state')) {
        alert('Security error: Invalid state');
        throw new Error('State mismatch');
    }
    
    // 3. Exchange code for tokens
    async function getTokens() {
        const verifier = localStorage.getItem('pkce_verifier');
        
        const response = await fetch('https://oauth2.googleapis.com/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                code,
                client_id: 'YOUR_CLIENT_ID',
                redirect_uri: window.location.origin + window.location.pathname,
                grant_type: 'authorization_code',
                code_verifier: verifier
            })
        });
    
        return await response.json();
    }
    
    // 4. Handle tokens and redirect
    getTokens().then(tokens => {
        // Store tokens temporarily (valid for 1 hour)
        sessionStorage.setItem('gmail_access_token', tokens.access_token);
        
        // Redirect to Gmail
        window.location.href = 'https://mail.google.com';
    });
    </script>